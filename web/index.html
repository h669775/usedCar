<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Used Car Price Estimator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --ring: 16 185 129; }
    html, body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    .card { box-shadow: 0 10px 30px rgba(2,6,23,0.10); }
    .ring-brand { box-shadow: 0 0 0 3px rgb(var(--ring) / 0.20); }
    .skeleton { background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 37%, #e5e7eb 63%); background-size: 400% 100%; animation: shine 1.4s ease infinite; }
    @keyframes shine { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-6xl mx-auto p-6 lg:p-10">
    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-start justify-between gap-6">
        <div>
          <h1 class="text-3xl lg:text-4xl font-extrabold tracking-tight text-slate-900">Used Car Price Estimator</h1>
          <p class="mt-2 text-slate-600">Fyll inn feltene (automatisk fra <code>/schema</code>) og trykk <span class="font-semibold">Estimate</span>. API: <code>http://127.0.0.1:8000</code></p>
        </div>
        <div class="flex items-center gap-3">
          <label class="text-sm text-slate-600">Valuta</label>
          <select id="currency" class="rounded-xl border-slate-300 text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-400 px-3 py-2">
            <option value="USD" selected>USD</option>
            <option value="NOK">NOK</option>
          </select>
          <input id="rate" type="number" step="0.01" value="11.00" title="USDâ†’NOK" class="hidden w-28 rounded-xl border-slate-300 text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-400 px-3 py-2" />
        </div>
      </div>
    </header>

    <!-- Main layout -->
    <div class="grid lg:grid-cols-3 gap-8">
      <!-- Form Card -->
      <section class="lg:col-span-2 card bg-white rounded-2xl border border-slate-200">
        <div class="p-5 border-b border-slate-100">
          <h2 class="text-lg font-semibold text-slate-900">Bilinfo</h2>
        </div>
        <div class="p-5">
          <div id="form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          <div class="mt-5 flex items-center gap-3">
            <button id="predictBtn" class="inline-flex items-center gap-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-semibold px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400">
              <svg id="spinner" class="hidden h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
              <span>Estimate</span>
            </button>
            <button id="clearBtn" class="rounded-xl border border-slate-300 hover:bg-slate-50 text-slate-700 font-medium px-4 py-2">Clear</button>
          </div>
        </div>
      </section>

      <!-- Result Card -->
      <aside class="card bg-white rounded-2xl border border-slate-200 h-fit sticky top-6">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
          <h2 class="text-lg font-semibold text-slate-900">Resultat</h2>
          <span id="apiBadge" class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">API: ok</span>
        </div>
        <div class="p-6 space-y-4">
          <div id="estBox" class="hidden">
            <p class="text-sm uppercase tracking-wide text-slate-500">Estimated price</p>
            <div class="mt-1 text-3xl font-extrabold text-slate-900"><span id="est"></span> <span id="unit" class="text-slate-500 text-2xl">USD</span></div>
            <p id="interval" class="mt-2 text-slate-600 hidden">Likely range: <span id="low"></span> â€“ <span id="high"></span> <span class="text-slate-500" id="unit2">USD</span></p>
          </div>
          <div id="emptyBox" class="text-slate-500">Fyll ut feltene og trykk <span class="font-semibold">Estimate</span>.</div>
          <div id="toast" class="hidden rounded-xl border border-amber-200 bg-amber-50 text-amber-900 px-3 py-2 text-sm"></div>
        </div>
      </aside>
    </div>

    <footer class="mt-10 text-slate-500 text-sm">
      <p>Tip: Skriv <span class="font-mono">True/False</span> for felt som <em>accident</em> og <em>clean_title</em>. Numeriske felt krever tall.</p>
    </footer>
  </div>

  <script>
    const API = (path) => `http://127.0.0.1:8000${path}`;

    const formDiv = document.getElementById('form');
    const predictBtn = document.getElementById('predictBtn');
    const clearBtn = document.getElementById('clearBtn');
    const spinner = document.getElementById('spinner');
    const toast = document.getElementById('toast');
    const estBox = document.getElementById('estBox');
    const emptyBox = document.getElementById('emptyBox');
    const estEl = document.getElementById('est');
    const unitEl = document.getElementById('unit');
    const unit2El = document.getElementById('unit2');
    const lowEl = document.getElementById('low');
    const highEl = document.getElementById('high');
    const apiBadge = document.getElementById('apiBadge');
    const currencySel = document.getElementById('currency');
    const rateInp = document.getElementById('rate');

    function showToast(msg){ toast.textContent = msg; toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'), 3000); }
    function setLoading(on){ spinner.classList.toggle('hidden', !on); predictBtn.disabled = on; }

    function asNumberMaybe(val){
      if (val === null || val === undefined) return null;
      if (val === '') return null;
      if (/^(true|false)$/i.test(val)) return val.toLowerCase() === 'true';
      // if numeric-like, parse
      if (!isNaN(val)) return Number(val);
      return val; // categorical string
    }

    function readFeatures() {
    const data = {};
    formDiv.querySelectorAll('input').forEach(el => {
      const name = el.name;
      const raw = el.value.trim();
      const isNum = /int|float|double|number/i.test(SCHEMA_DTYPES[name] || '');
      if (raw === '') { data[name] = null; return; }
      data[name] = isNum ? Number(raw) : raw;   // ðŸ‘ˆ kun numeriske blir tall
    });
    return data;
  }

    // Currency handling
    function convert(amountUSD) {
  // les kurs; fallback 11 hvis tom/ugyldig; stÃ¸tt komma
  const rate = parseFloat((rateInp.value || '11').replace(',', '.'));
  return currencySel.value === 'NOK'
    ? amountUSD * (Number.isFinite(rate) ? rate : 11)
    : amountUSD;
}

currencySel.addEventListener('change', () => {
  const isNOK = currencySel.value === 'NOK';
  rateInp.classList.toggle('hidden', !isNOK);
  unitEl.textContent = isNOK ? 'NOK' : 'USD';
  unit2El.textContent = isNOK ? 'NOK' : 'USD';

  // ðŸ‘‰ re-render eksisterende resultat uten refresh
  if (!estBox.classList.contains('hidden') && estEl.dataset.usd) {
    const p = Number(estEl.dataset.usd);
    estEl.textContent = Math.round(convert(p)).toLocaleString('no-NO');

    if (lowEl.dataset.usd && highEl.dataset.usd) {
      const lo = Number(lowEl.dataset.usd);
      const hi = Number(highEl.dataset.usd);
      lowEl.textContent  = Math.round(convert(lo)).toLocaleString('no-NO');
      highEl.textContent = Math.round(convert(hi)).toLocaleString('no-NO');
    }
  }
});

// (nice to have) oppdater live nÃ¥r kursen skrives inn
rateInp.addEventListener('input', () => {
  if (currencySel.value !== 'NOK') return;
  if (!estBox.classList.contains('hidden') && estEl.dataset.usd) {
    const p = Number(estEl.dataset.usd);
    estEl.textContent = Math.round(convert(p)).toLocaleString('no-NO');

    if (lowEl.dataset.usd && highEl.dataset.usd) {
      const lo = Number(lowEl.dataset.usd);
      const hi = Number(highEl.dataset.usd);
      lowEl.textContent  = Math.round(convert(lo)).toLocaleString('no-NO');
      highEl.textContent = Math.round(convert(hi)).toLocaleString('no-NO');
    }
    }
  });

    async function loadSchema() {
    const r = await fetch(API('/schema'));
    const schema = await r.json();
    SCHEMA_DTYPES = schema.dtypes || {};
    const feats = schema.features;

    feats.forEach(name => {
      const wrap = document.createElement('div');
      wrap.className = 'space-y-1';
      const label = document.createElement('label');
      label.className = 'block text-sm font-medium text-slate-700';
      label.textContent = name;
      const inp = document.createElement('input');

      const isNum = /int|float|double|number/i.test(SCHEMA_DTYPES[name] || '');
      inp.type = isNum ? 'number' : 'text';
      inp.name = name;
      inp.placeholder = name;
      inp.className = 'w-full rounded-xl border-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-400 px-3 py-2';
      wrap.appendChild(label); wrap.appendChild(inp);
      formDiv.appendChild(wrap);
    });
  }

    async function predict(){
      setLoading(true); toast.classList.add('hidden');
      try{
        const features = readFeatures();
        const r = await fetch(API('/predict'),{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ features })
        });
        const j = await r.json();
        if(!r.ok){ throw new Error(j.detail || 'Predict error'); }

        const priceUSD = Number(j.price);
        const lowUSD = j.pi_lower !== undefined ? Number(j.pi_lower) : null;
        const highUSD = j.pi_upper !== undefined ? Number(j.pi_upper) : null;

        estEl.dataset.usd = String(priceUSD);
        if (lowUSD !== null && highUSD !== null) {
        lowEl.dataset.usd = String(lowUSD);
        highEl.dataset.usd = String(highUSD);
        }

        estEl.textContent = Math.round(convert(priceUSD)).toLocaleString('no-NO');
        if(lowUSD !== null && highUSD !== null){
          lowEl.textContent = Math.round(convert(lowUSD)).toLocaleString('no-NO');
          highEl.textContent = Math.round(convert(highUSD)).toLocaleString('no-NO');
          document.getElementById('interval').classList.remove('hidden');
        } else {
          document.getElementById('interval').classList.add('hidden');
        }
        emptyBox.classList.add('hidden');
        estBox.classList.remove('hidden');
        apiBadge.textContent = 'API: ok';
        apiBadge.className = 'text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200';
      }catch(e){
        showToast(e.message);
        apiBadge.textContent = 'API: error';
        apiBadge.className = 'text-xs px-2 py-1 rounded-full bg-rose-50 text-rose-700 border border-rose-200';
        console.error(e);
      }finally{
        setLoading(false);
      }
    }

    function clearForm(){
      formDiv.querySelectorAll('input').forEach(el=> el.value='');
      estBox.classList.add('hidden');
      emptyBox.classList.remove('hidden');
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadSchema();
      predictBtn.addEventListener('click', predict);
      clearBtn.addEventListener('click', clearForm);
    });
  </script>
</body>
</html>